name: Daily YouTube Upload

on:
  schedule:
    # 7:45 AM Nepal (UTC+5:45) = 2:00 AM UTC
    - cron: '0 2 * * *'
    # 6:45 PM Nepal (UTC+5:45) = 1:00 PM UTC
    - cron: '0 13 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies (MoviePy)
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        # Fix ImageMagick policy for MoviePy
        sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml

    - name: Install Python dependencies
      run: |
        pip install -r footybitez/requirements.txt
        pip install python-dotenv

    - name: Run Automation
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
        ENABLE_UPLOAD: "true"
      run: |
        # Ensure paths work correctly relative to root
        export PYTHONPATH=$PYTHONPATH:.
        python footybitez/main.py

    - name: Upload Logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: automation-logs
        path: footybitez/logs/

    - name: Upload Generated Video (Debug)
      uses: actions/upload-artifact@v4
      with:
        name: final-video
        path: footybitez/output/final_short.mp4
